<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.futeplus.vms.dao.StoreDao">

	<!-- 增加商户 -->
	<insert id="addStore" useGeneratedKeys="true" keyProperty="id" parameterType="com.futeplus.vms.entity.StoreInfo">
		insert into
		storeInfo(typeId,bdId,storeId,storeName,address,areacode,lon,lat,returnType,returnPwd,examineState,createTime)
		value(#{typeId},#{bdId},#{storeId},#{storeName},#{address},#{areacode},#{lon},#{lat},#{returnType}
		,#{returnPwd},#{examineState},#{createTime})
	</insert>
	
	<!-- 更新商户 -->
	<update id="updateStore" parameterType="com.futeplus.vms.entity.StoreInfo">
		update storeInfo set typeId=#{typeId},storeName=#{storeName},address=#{address},areacode=#{areacode}
		,lon=#{lon},lat=#{lat},returnType=#{returnType},returnPwd=#{returnPwd},examineState=#{examineState}
		,updateTime=#{updateTime},cooperateTime=#{cooperateTime} where id=#{id}
	</update>
	
	<!-- 获取商户信息 -->
	<select id="getStore" resultType="com.futeplus.vms.entity.StoreInfo">
		select * from storeInfo where id=#{id}
	</select>
	
	<!-- 获取商户信息 -->
	<select id="getStoreByStoreId" resultType="com.futeplus.vms.entity.StoreInfo">
		select * from storeInfo where storeId=#{storeId}
	</select>
	
	<!-- 查询指定条件下的商户信息 -->
	<select id="loadStoreWithQuery" resultType="java.util.HashMap" parameterType="com.futeplus.vms.entity.StoreQueryBean">
		select tt.*,t1.city,t1.region
		,(select fullname from bdInfo where id=tt.bdId) as bdName
		,(select dictName from dictInfo where dictCode='store_type' and dictValue=tt.typeId) as typeName
		,(select dictName from dictInfo where dictCode='store_examine_state' and dictValue=tt.examineState) as stateName
		from (select t.id,t.bdId,t.typeId,t.storeName,t.areacode,t.examineState,t.createTime
		,(select count(id) from chargerInfo where sid=t.id) as pbTotalNo from storeInfo t
		<trim prefix="where" prefixOverrides="and">
			<if test="examineState != ''">
				and t.examineState=#{examineState}
			</if>
			<if test="areacode.toString().length() &gt; 2">
				and t.areacode=#{areacode}
			</if>
			<if test="areacode.toString().length() == 2">
				and substring(t.areacode,1,2)=#{areacode}
			</if>
			<if test="typeId != ''">
				and t.typeId=#{typeId}
			</if>
			<if test="storeName!=''">
				and t.storeName like concat('%',#{storeName},'%')
			</if>
			<if test="bdId &gt; 0">
				and t.bdId=#{bdId}
			</if>
			<choose>
				<when test="createTimeB != '' and createTimeE == ''">
					and substring(t.createTime,1,10) &gt;= #{createTimeB}
				</when>
				<when test="createTimeB == '' and createTimeE != ''">
					and substring(t.createTime,1,10) &lt;= #{createTimeE}
				</when>
				<when test="createTimeB != '' and createTimeE != ''">
					and substring(t.createTime,1,10) between #{createTimeB} and #{createTimeE}
				</when>
			</choose>
		</trim>
		) as tt left join areaInfo t1 on (tt.areacode=t1.areacode)
		<trim prefix="where" prefixOverrides="and">
			<choose>
				<when test="pbTotalNoB &gt;= 0 and pbTotalNoE &lt; 0">
					and tt.pbTotalNo &gt;= #{pbTotalNoB}
				</when>
				<when test="pbTotalNoB &lt; 0 and pbTotalNoE &gt;= 0">
					and tt.pbTotalNo &lt;= #{pbTotalNoE}
				</when>
				<when test="pbTotalNoB &gt;= 0 and pbTotalNoE &gt;= 0">
					and tt.pbTotalNo between #{pbTotalNoB} and #{pbTotalNoE}
				</when>
			</choose>
		</trim>
		 order by tt.createTime desc,id desc
	</select>
	
	<!-- 根据商户名查询商户 -->
	<select id="getStoreByFullName" resultType="com.futeplus.vms.entity.StoreInfo">
		select * from storeInfo where storeName=#{storeName}
	</select>
	
</mapper>  
